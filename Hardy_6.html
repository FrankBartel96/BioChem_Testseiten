<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>Genotypfrequenzen – Schrittweise Simulation</title>
    <script src="libs/chart.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #F6F8E2;
            padding: 40px;
            color: #333;
            max-width: 900px;
            margin: auto;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: 500;
        }

        input {
            padding: 6px 10px;
           
            border-radius: 12px;
            border: 1px solid #ccc;
            font-size: 1rem;
            margin-top: 4px;
            width: 100%;
            max-width: 90px;
        }

        button {
            background: #007aff;
            border: none;
            color: white;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

            button:hover {
                background: #005ce6;
            }

        canvas {
            margin-top: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }

        .section {
            margin-bottom: 30px;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        textarea {
            width: 100%;
            height: 180px;
            padding: 12px;
            font-size: 0.95rem;
            border-radius: 12px;
            border: 1px solid #ccc;
            background: #fff;
        }
    </style>
</head>
<body>
    <h1>Schrittweise Genotypfrequenz-Simulation </h1>
    <h3> (Hardy-Weinberg-Gesetz)   </h3>
    für jede neue Generation klicken; Änderungen können vor jedem Klick hinzugefügt werden
    <div class="section row">
        <div>
            <label>Populationsgröße</label>
            <input type="number" id="populationSize" value="200" min="10" />
            200
        </div>
        <div>
            <label>Anfangsfrequenz A (p)</label>
            <input type="number" id="startP" value="0.5" step="0.01" />
            0,5
        </div>
        <div>
            <label>Dominanz (h)</label>
            <input type="number" id="dominance" value="0.5" step="0.01" min="0" max="1" />
            0,5
        </div>
        <div>
            <label>Mutation A→a (μ)</label>
            <input type="number" id="mu" value="0.001" step="0.0001" />
            0,001
        </div>
        <div>
            <label>Mutation a→A (ν)</label>
            <input type="number" id="nu" value="0.001" step="0.0001" />
            0,001
        </div>
        <div>
            <label>Migrationsrate (m)</label>
            <input type="number" id="migrationRate" value="0.01" step="0.001" />
            0,01
        </div>
        <div>
            <label>p<sub>mig</sub> Zielfrequenz</label>
            <input type="number" id="migrationTarget" value="0.5" step="0.01" />
            0,01
        </div>
        <div>
            <label>Max. Generationen</label>
            <input type="number" id="maxGenerations" value="100" min="1" />
            100
        </div>
    </div>

    <!-- Button-Gruppe zentriert -->
    <div class="button-group">
        <button onclick="startSimulation()">▶️ Start / Weiter</button>
        <button onclick="resetSimulation()">♻️ Reset</button>
        <button onclick="location.reload()">🔄 Seite neu laden</button>
    </div>

    <canvas id="genotypeChart"></canvas>

    <div class="section">
        <h2>Erklärung</h2>
        <textarea readonly>
Das populationsgenetische Modell besagt, dass in einer idealen Population die Allel- und Genotypfrequenzen aa,aA,AA über Generationen hinweg konstant bleiben, wenn keine evolutionären Einflüsse wirken.
Theoretische Bedingungen: zufällige Paarung, große Populationsgröße, fehlender Genfluss, keine Mutationen und keine Selektion. 
In diesem Programm wurde die Simulation aber auf einige Evolutionsfaktoren erweitert. 
Die Simulation zeigt die Entwicklung der Genotypfrequenzen (AA, Aa, aa) einer Population pro Generation – Schritt für Schritt. 
Sie basiert auf den Regeln der Mendelschen Vererbung (Hardy-Weinberg-Gleichgewicht) und erlaubt zusätzlich Mutationen.

Nutze die Parameter oben, um verschiedene Szenarien zu erkunden!

Jede Generation werden neue Allelfrequenzen berechnet, wobei Mutation berücksichtigt wird:
  p' = p × (1 - μ) + q × ν
  q' = q × (1 - ν) + p × μ

Eine größere Mutationsrate kann langfristig dominante oder rezessive Allele verdrängen.

Diese Simulation zeigt die Entwicklung von Genotypfrequenzen (AA, Aa, aa) unter Einfluss von:

1. Startfrequenzen: Beginne mit einem beliebigen Verhältnis der Allele A und a
2. Mutation (μ: A → a, ν: a → A) verändert Allelfrequenzen 
   - μ (A → a): Wahrscheinlichkeit, dass ein A-Allel mutiert
   - ν (a → A): Wahrscheinlichkeit, dass ein a-Allel mutiert
3. Selektion : bevorzugt bestimmte Genotypen durch Fitness-Vorteile  (Fitness-Werte)
4. Migration : gleicht lokale Frequenz durch Austausch mit externer Population an(mit Migrationsrate m zu einer Zielallelfrequenz p_mig)

Formeln:
- Mutation: p' = p(1-μ) + qν  
- Selektion: Genotypfrequenzen × Fitness → normiert  
- Migration: p'' = (1 - m)p + m * pmig

Sie berücksichtigt:
- Mutation (μ, ν): (A↔a) Umwandlug
- Dominanz  (h): bestimmt, wie Aa sich zwischen AA und aa verhält (Fitness von Aa zwischen AA und aa)
- Migration (m): Austausch mit externer Population (Ziel-p) (zu einer Ziel-Allelfrequenz-pmig)
- Genetische Drift (Zufallsprozesse in kleiner Population)

⚙ Steuerung:
für jede neue Generation klicken; Änderungen können vor jedem Klick hinzugefügt werden
- "▶️ Start / Weiter": führt eine weitere Generation aus
- "♻️ Reset": startet die Simulation mit aktuellen Parametern neu
- "🔄 Seite neu laden": lädt die Seite vollständig zurück
    </textarea>
    </div>

    <script>let chart;
    let generation = 0;
    let p = 0;
    let q = 0;
    let maxGen = 100;
    let AAData = [], AaData = [], aaData = [], labels = [];

    function resetSimulation() {
      const startP = parseFloat(document.getElementById("startP").value);
      const maxGenerations = parseInt(document.getElementById("maxGenerations").value);

      p = startP;
      q = 1 - p;
      generation = 0;
      maxGen = maxGenerations;
      AAData = [];
      AaData = [];
      aaData = [];
      labels = [];

      drawChart(); // Leeres Chart
    }

    function startSimulation() {
      if (generation >= maxGen) return;

      const N = parseInt(document.getElementById("populationSize").value);
      const mu = parseFloat(document.getElementById("mu").value);
      const nu = parseFloat(document.getElementById("nu").value);
      const h = parseFloat(document.getElementById("dominance").value);
      const m = parseFloat(document.getElementById("migrationRate").value);
      const p_mig = parseFloat(document.getElementById("migrationTarget").value);

      // 1. Genotypfrequenzen
      let freqAA = p * p;
      let freqAa = 2 * p * q;
      let freqaa = q * q;

      // 2. Selektion mit Dominanz
      const wAA = 1;
      const wAa = 1 - h;
      const waa = 0;
      const wBar = freqAA * wAA + freqAa * wAa + freqaa * waa;

      freqAA = (freqAA * wAA) / wBar;
      freqAa = (freqAa * wAa) / wBar;
      freqaa = (freqaa * waa) / wBar;

      // 3. Mutation
      const p_after_mut = (freqAA + 0.5 * freqAa) * (1 - mu) + (freqaa + 0.5 * freqAa) * nu;
      p = p_after_mut;
      q = 1 - p;

      // 4. Migration
      p = (1 - m) * p + m * p_mig;
      q = 1 - p;

      // 5. Drift (Sampling)
      const alleles = 2 * N;
      const pSample = Math.round(p * alleles);
      p = pSample / alleles;
      q = 1 - p;

      // 6. Genotypfrequenzen speichern
      let finalAA = p * p;
      let finalAa = 2 * p * q;
      let finalaa = q * q;

      AAData.push(finalAA * 100);
      AaData.push(finalAa * 100);
      aaData.push(finalaa * 100);
      labels.push(`Gen ${generation}`);

      generation++;
      drawChart();
    }

    function drawChart() {
      const data = {
        labels: labels,
        datasets: [
          {
            label: "AA (%)",
            data: AAData,
            borderColor: "rgba(0, 122, 255, 1)",
            backgroundColor: "rgba(0, 122, 255, 0.1)",
            tension: 0.3
          },
          {
            label: "Aa (%)",
            data: AaData,
            borderColor: "rgba(255, 159, 10, 1)",
            backgroundColor: "rgba(255, 159, 10, 0.1)",
            tension: 0.3
          },
          {
            label: "aa (%)",
            data: aaData,
            borderColor: "rgba(255, 69, 58, 1)",
            backgroundColor: "rgba(255, 69, 58, 0.1)",
            tension: 0.3
          }
        ]
      };

      const config = {
        type: "line",
        data: data,
        options: {
          responsive: true,
          animation: false,
          plugins: {
            title: {
              display: true,
              text: `Genotypfrequenzen bis Generation ${generation}`
            }
          },
          scales: {
            y: {
              min: 0,
              max: 100,
              title: {
                display: true,
                text: "Frequenz (%)"
              }
            }
          }
        }
      };

      if (chart) chart.destroy();
      chart = new Chart(document.getElementById("genotypeChart"), config);
    }

    // Initialisieren bei Seitenaufruf
    resetSimulation();</script>
</body>
</html>
