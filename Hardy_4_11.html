<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>Genotypfrequenzen – Simulation</title>
    <script src="libs/chart.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #F6F8E2;
            padding: 40px;
            color: #333;
            max-width: 900px;
            margin: auto;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #111;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: 500;
        }

        input {
            padding: 6px 10px;
            border-radius: 12px;
            border: 1px solid #ccc;
            font-size: 1rem;
            margin-top: 4px;
            width: 100%;
            max-width: 90px;
        }

        button {
            background: #007aff;
            border: none;
            color: white;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 12px;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

            button:hover {
                background: #005ce6;
            }

        canvas {
            margin-top: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }

        .section {
            margin-bottom: 30px;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        textarea {
            width: 100%;
            height: 180px;
            padding: 12px;
            font-size: 0.95rem;
            border-radius: 12px;
            border: 1px solid #ccc;
            background: #fff;
        }
    </style>
</head>
<body>
    <h1>Simulation der Genotypfrequenzen mit Drift, Dominanz (Animation)</h1>
    stopp/weiter Resetbutton einfügen
    <div class="section row">
        <div>
            <label>Populationsgröße</label>
            <input type="number" id="populationSize" value="200" min="10" />
            200
        </div>
        <div>
            <label>Startfrequenz A (p)</label>
            <input type="number" id="startP" value="0.5" step="0.01" />
            0,5
        </div>
        <div>
            <label>Dominanz h (0–1)</label>
            <input type="number" id="dominance" value="0.5" step="0.01" min="0" max="1" />
            0,5
        </div>
        <div>
            <label>Mutation A→a (μ)</label>
            <input type="number" id="mu" value="0.001" step="0.0001" />
            0,001
        </div>
        <div>
            <label>Mutation a→A (ν)</label>
            <input type="number" id="nu" value="0.001" step="0.0001" />
            0,001
        </div>
        <div>
            <label>Migrationsrate (m)</label>
            <input type="number" id="migrationRate" value="0.01" step="0.001" />
            0,01
        </div>
        <div>
            <label>p<sub>mig</sub> Zielfrequenz</label>
            <input type="number" id="migrationTarget" value="0.5" step="0.01" />
            0,5
        </div>
        <div>
            <label>Max. Generationen</label>
            <input type="number" id="maxGenerations" value="100" min="1" />
            100
        </div>

        <button id="startBtn" onclick="startSimulation()">▶️ Start</button>

        <button id="pauseBtn" onclick="pauseResumeSimulation()">⏸️ Stop</button>
        <button onclick="resetChartOnly()">🔁 Reset</button>

        <button onclick="location.reload()">🔄 Seite neu laden</button>
    </div>

    <canvas id="genotypeChart"></canvas>

    <div class="section">
        <h2>Erklärung</h2>
        <textarea readonly>
Das populationsgenetische Modell besagt, dass in einer idealen Population die Allel- und Genotypfrequenzen aa,aA,AA über Generationen hinweg konstant bleiben, wenn keine evolutionären Einflüsse wirken.
Theoretische Bedingungen: zufällige Paarung, große Populationsgröße, fehlender Genfluss, keine Mutationen und keine Selektion. 
In diesem Programm wurde die Simulation aber auf einige Evolutionsfaktoren erweitert. 
Die Simulation zeigt die Entwicklung der Genotypfrequenzen (AA, Aa, aa) einer Population pro Generation – animiert. 
Sie basiert auf den Regeln der Mendelschen Vererbung (Hardy-Weinberg-Gleichgewicht) und erlaubt zusätzlich Mutationen.

Nutze die Parameter oben, um verschiedene Szenarien zu erkunden!

Jede Generation werden neue Allelfrequenzen berechnet, wobei Mutation berücksichtigt wird: 
Eine größere Mutationsrate kann langfristig dominante oder rezessive Allele verdrängen.

Diese Simulation zeigt die Entwicklung von Genotypfrequenzen (AA, Aa, aa) unter Einfluss von:
Die Animation läuft generationenweise ab und zeigt, wie die Genotypfrequenzen (AA, Aa, aa) sich über Zeit verändern.

1. Startfrequenzen: Beginne mit einem beliebigen Verhältnis der Allele A und a
2. Mutation (μ: A → a, ν: a → A) verändert Allelfrequenzen 
   - μ (A → a): Wahrscheinlichkeit, dass ein A-Allel mutiert
   - ν (a → A): Wahrscheinlichkeit, dass ein a-Allel mutiert
3. Selektion : bevorzugt bestimmte Genotypen durch Fitness-Vorteile  (Fitness-Werte)
4. Migration : gleicht lokale Frequenz durch Austausch mit externer Population an(mit Migrationsrate m zu einer Zielallelfrequenz p_mig)

Formeln:
- Mutation: p' = p(1-μ) + qν  ; Migration: p'' = (1 - m)p + m * pmig
- Selektion: Genotypfrequenzen × Fitness → normiert  

Sie berücksichtigt:
- Mutation (μ, ν): (A↔a) Umwandlug
- Dominanz  (h): bestimmt, wie Aa sich zwischen AA und aa verhält (Fitness von Aa zwischen AA und aa)
- Migration (m): Austausch mit externer Population (Ziel-p) (zu einer Ziel-Allelfrequenz-pmig)
- Genetische Drift (Zufallsprozesse in kleiner Population)

⚙ Steuerung:
- "▶️ Start / Weiter": führt eine weitere Generation aus
- "🔄 Seite neu laden": lädt die Seite vollständig zurück

        </textarea>
    </div>

    <script>
        let chart;
        let timer = null;
        let gen = 0;
        let AAData = [], AaData = [], aaData = [];
        let labels = [];

        let p, q;
        let paused = false;

        function resetSimulation() {
            gen = 0;
            AAData = [];
            AaData = [];
            aaData = [];
            labels = [];

            const startP = parseFloat(document.getElementById("startP").value);
            p = startP;
            q = 1 - p;
        }

        function resetChartOnly() {
            clearInterval(timer);
            timer = null;
            paused = false;
            document.getElementById("startBtn").innerText = "▶️ Start";
            document.getElementById("pauseBtn").innerText = "⏸️ Stop";
            resetSimulation();
            drawChart(); // leeren Chart anzeigen
        }

        function startSimulation() {
            resetSimulation();
            timer = setInterval(nextGeneration, 200);
            document.getElementById("startBtn").innerText = "🔄 Läuft...";
            document.getElementById("pauseBtn").innerText = "⏸️ Stop";
            paused = false;
        }

        function pauseResumeSimulation() {
            const pauseBtn = document.getElementById("pauseBtn");
            if (paused) {
                timer = setInterval(nextGeneration, 200);
                pauseBtn.innerText = "⏸️ Stop";
                paused = false;
            } else {
                clearInterval(timer);
                timer = null;
                pauseBtn.innerText = "▶️ Weiter";
                paused = true;
            }
        }

        function nextGeneration() {
            const maxGenerations = parseInt(document.getElementById("maxGenerations").value);
            if (gen >= maxGenerations) {
                clearInterval(timer);
                timer = null;
                document.getElementById("pauseBtn").innerText = "▶️ Weiter";
                return;
            }

            const N = parseInt(document.getElementById("populationSize").value);
            const mu = parseFloat(document.getElementById("mu").value);
            const nu = parseFloat(document.getElementById("nu").value);
            const h = parseFloat(document.getElementById("dominance").value);
            const m = parseFloat(document.getElementById("migrationRate").value);
            const p_mig = parseFloat(document.getElementById("migrationTarget").value);

            let freqAA = p * p;
            let freqAa = 2 * p * q;
            let freqaa = q * q;

            const wAA = 1;
            const wAa = 1 - h;
            const waa = 0;

            const wBar = freqAA * wAA + freqAa * wAa + freqaa * waa;

            freqAA = (freqAA * wAA) / wBar;
            freqAa = (freqAa * wAa) / wBar;
            freqaa = (freqaa * waa) / wBar;

            let p_mut = (freqAA + 0.5 * freqAa) * (1 - mu) + (freqaa + 0.5 * freqAa) * nu;
            p = p_mut;
            q = 1 - p;

            p = (1 - m) * p + m * p_mig;
            q = 1 - p;

            const alleleCount = 2 * N;
            const p_sampled = Math.round(p * alleleCount);
            const new_p = p_sampled / alleleCount;
            p = new_p;
            q = 1 - p;

            let finalAA = p * p;
            let finalAa = 2 * p * q;
            let finalaa = q * q;

            AAData.push(finalAA * 100);
            AaData.push(finalAa * 100);
            aaData.push(finalaa * 100);
            labels.push(`Gen ${gen}`);
            gen++;

            drawChart();
        }

        function drawChart() {
            const data = {
                labels: labels,
                datasets: [
                    {
                        label: "AA (%)",
                        data: AAData,
                        borderColor: "rgba(0, 122, 255, 1)",
                        backgroundColor: "rgba(0, 122, 255, 0.1)",
                        tension: 0.3
                    },
                    {
                        label: "Aa (%)",
                        data: AaData,
                        borderColor: "rgba(255, 159, 10, 1)",
                        backgroundColor: "rgba(255, 159, 10, 0.1)",
                        tension: 0.3
                    },
                    {
                        label: "aa (%)",
                        data: aaData,
                        borderColor: "rgba(255, 69, 58, 1)",
                        backgroundColor: "rgba(255, 69, 58, 0.1)",
                        tension: 0.3
                    }
                ]
            };

            const config = {
                type: "line",
                data: data,
                options: {
                    responsive: true,
                    animation: false,
                    plugins: {
                        title: {
                            display: true,
                            text: "Genotypfrequenzen (Live-Simulation)"
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: "Frequenz (%)"
                            }
                        }
                    }
                }
            };

            if (chart) chart.destroy();
            chart = new Chart(document.getElementById("genotypeChart"), config);
        }
    </script>


</body>
</html>
