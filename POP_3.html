<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Populationswachstum Simulation – Stabilitätscheck</title>
    <script src="libs/chart.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #F6F8E2;
        }

        h1 {
            text-align: center;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

            .controls label {
                display: flex;
                flex-direction: column;
                font-size: 14px;
            }

        .chart-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-box {
            width: 45%;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        canvas {
            max-width: 100%;
        }

        button {
            justify-content: center;
            padding: 12px 12px;
            margin-top: 10px;
            border: none;
            border-radius: 12px;
            background-color: #0071e3;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

            button:hover {
                background-color: #005bb5;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            }

        .cat-image {
            position: absolute;
            left: 800px;
            top: 650px;
            width: 50%;
            margin: auto;
        }

            .cat-image img {
                width: 70%;
                border-radius: 12px;
            }

        .info-box {
            position: relative;
            max-width: 600px;
            margin: 30px;
            background-color: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            font-size: 16px;
            line-height: 1.6;
        }

            .info-box h3 {
                font-size: 20px;
                font-weight: 600;
                margin-bottom: 12px;
                color: #1d1d1f;
            }

            .info-box p {
                margin: 6px 0;
                color: #3a3a3c;
            }

        select,
        input[type="number"] {
            font-size: 16px;
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid #ccc;
            width: 90%;
            max-width: 110px;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <h1>Simulation des Populationswachstums</h1>

    <div class="cat-image">
        <img src="./Pics/popwachstum.png" alt="Katze" id="catImage">
    </div>

    <div class="controls">
        <label>
            Reproduktionsfaktor (r):
            <input type="number" id="r" value="0.1" step="0.01" min="0.01">
            Vermehrungsrate
        </label>
        <label>
            Kapazitätsfaktor (K):
            <input type="number" id="k" value="100" step="1" min="10">
            Pop-Dichte
        </label>
        <label>
            Startpopulation (N₀):
            <input type="number" id="n0" value="10" step="1" min="1">
            Individuen
        </label>
        <label>
            Schritte:
            <input type="number" id="steps" value="100" step="10" min="10">
            Messpunkte/Zeit
        </label>
        <label>
            Zeitschritt (Δt):
            <input type="number" id="dt" value="0.1" step="0.01" min="0.01">
        </label>
        <label>
            Modell:
            <select id="model">
                <option value="logistisch">Logistisch</option>
                <option value="exponentiell">Exponentiell</option>
            </select>
        </label>
        <label>
            Geschwindigkeit (ms):
            <input type="range" id="speed" min="10" max="500" value="50">
            <span id="speedValue">50</span>
        </label>

        <button onclick="pauseAnimation()">⏸ Pause</button>
        <button onclick="resumeAnimation()">▶ Weiter</button>
        <button onclick="window.location.reload()">🔄 Neu laden</button>

        <label>
            <input type="checkbox" id="compareMode"> Vergleichsmodus (2 Diagramme)
        </label>
        <button onclick="simulate()">Simulieren</button>
    </div>

    <div class="chart-container">
        <div class="chart-box">
            <canvas id="simulationChart"></canvas>
        </div>
        <div class="chart-box" id="analyticBox" style="display:none;">
            <canvas id="analyticChart"></canvas>
        </div>
    </div>

    <div class="info-box">
        <h3>Biologische Erklärung:</h3>
        <p>Beispiele:</p>
        <p>1. r=3; K=4; N₀=2; Schritte 10; Δt=0.6</p>
        <p>2. r=6; K=8; N₀=2; Schritte 10; Δt=0.33</p>
        <p>3. r=3; K=6; N₀=2; Schritte 100; Δt=0.666</p>
        <p>4. r=0.9; K=900; N₀=5; Schritte 100; Δt=2.222</p>
        <p>5. r=0.1; K=9000; N₀=5; Schritte 100; Δt=20</p>
    </div>

    <script>
        let simChart, analyticChart;
        let animationId;
        let paused = false;
        let t, steps, dt, population, labels, r, K, model, N0;
        let analyticData = [];

        document.getElementById('speed').addEventListener('input', function () {
            document.getElementById('speedValue').textContent = this.value;
        });

        function checkStability(r, dt, model) {
            let maxDt = model === 'logistisch' ? 2 / r : 1 / r;
            if (dt > maxDt) {
                alert(`⚠ Δt=${dt} ist zu groß – wird auf ${maxDt.toFixed(3)} reduziert.`);
                return maxDt;
            }
            return dt;
        }

        function simulate() {
            if (animationId) clearTimeout(animationId);
            r = parseFloat(document.getElementById('r').value);
            K = parseFloat(document.getElementById('k').value);
            N0 = parseFloat(document.getElementById('n0').value);
            steps = parseInt(document.getElementById('steps').value);
            dt = parseFloat(document.getElementById('dt').value);
            model = document.getElementById('model').value;
            dt = checkStability(r, dt, model);

            population = [N0];
            labels = [0];
            analyticData = [];
            t = 1;
            paused = false;

            if (simChart) simChart.destroy();
            if (analyticChart) analyticChart.destroy();

            const ctxSim = document.getElementById('simulationChart').getContext('2d');
            const compareMode = document.getElementById('compareMode').checked;
            document.getElementById('analyticBox').style.display = compareMode ? 'block' : 'none';

            for (let i = 0; i <= steps; i++) {
                let time = i * dt;
                let val = model === 'logistisch'
                    ? K / (1 + ((K - N0) / N0) * Math.exp(-r * time))
                    : N0 * Math.exp(r * time);
                analyticData.push(val);
            }

            simChart = new Chart(ctxSim, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Numerische Simulation', data: population, borderColor: 'blue', tension: 0.2 }] },
                options: {
                    responsive: true,
                    animation: false,
                    plugins: { title: { display: true, text: `Simulation (${model})` } },
                    scales: { x: { title: { display: true, text: 'Zeit (t)' } }, y: { min: 0 } }
                }
            });

            if (compareMode) {
                const ctxAnalytic = document.getElementById('analyticChart').getContext('2d');
                analyticChart = new Chart(ctxAnalytic, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: steps + 1 }, (_, i) => (i * dt).toFixed(2)),
                        datasets: [{ label: 'Analytische Lösung', data: analyticData, borderColor: 'red', borderDash: [5, 5], tension: 0.2 }]
                    },
                    options: {
                        responsive: true,
                        animation: false,
                        plugins: { title: { display: true, text: `Analytische Lösung (${model})` } },
                        scales: { x: { title: { display: true, text: 'Zeit (t)' } }, y: { min: 0 } }
                    }
                });
            }

            step();
        }

        function step() {
            if (t > steps) return;
            if (paused) return animationId = setTimeout(step, 100);

            const N_prev = population[t - 1];
            const N_next = model === 'logistisch'
                ? N_prev + r * N_prev * (1 - N_prev / K) * dt
                : N_prev + r * N_prev * dt;

            population.push(N_next);
            labels.push((t * dt).toFixed(2));
            simChart.data.labels = labels;
            simChart.data.datasets[0].data = population;
            simChart.update();
            t++;

            const speed = parseInt(document.getElementById('speed').value);
            animationId = setTimeout(step, speed);
        }

        function pauseAnimation() { paused = true; }
        function resumeAnimation() { if (paused) { paused = false; step(); } }

        // 🧩 SAFARI-FIX:
        window.addEventListener("load", () => {
            setTimeout(simulate, 80);
        });
    </script>

</body>
</html>
