<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <title>Säure-Base Titrationssimulation — Safari-stabil</title>
    <script src="libs/chart.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #F6F8E2;
            color: #111;
        }

        h1 {
            margin-bottom: 8px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
            align-items: flex-start;
        }

        fieldset {
            padding: 8px 12px;
            border-radius: 10px;
        }

        select, input {
            border-radius: 8px;
            padding: 4px;
        }

        button {
            padding: 8px 14px;
            border-radius: 10px;
            background: #0071e3;
            color: #fff;
            border: none;
            cursor: pointer;
        }

            button:hover {
                background: #005bb5;
            }

        canvas {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: block;
            margin-top: 12px;
        }

        textarea {
            width: 80%;
        }
    </style>
</head>
<body>
    <h1>Säure-Base Titrationssimulation — verbesserte Gleichgewichtslösung</h1>

    <div class="controls">
        <fieldset>
            <legend>Maßlösung</legend>
            <label><input type="radio" name="base" value="NaOH" checked> NaOH</label><br>
            <label><input type="radio" name="base" value="KOH"> KOH</label><br>
            <label>Konzentration (mol/L): <input type="number" id="baseConc" value="0.1" step="0.01" min="0.001"></label>
        </fieldset>

        <fieldset>
            <legend>Probelösung</legend>
            <select id="acidSelect">
                <option value="HCl" data-pks="strong">Salzsäure (HCl)</option>
                <option value="H2SO4" data-pks="strong,2.0">Schwefelsäure (H₂SO₄)</option>
                <option value="HNO3" data-pks="strong">Salpetersäure (HNO₃)</option>
                <option value="H2SO3" data-pks="1.81,7.07">Schwefelige Säure (H₂SO₃)</option>
                <option value="H2CO3" data-pks="6.52,10.04">Kohlensäure (H₂CO₃)</option>
                <option value="HOOCCOOH" data-pks="1.23,4.19">Oxalsäure (HOOC-COOH)</option>
                <option value="CH3COOH" data-pks="4.76">Essigsäure (CH₃COOH)</option>
                <option value="H3PO4" data-pks="2.15,7.20,12.35">Phosphorsäure (H₃PO₄)</option>
            </select><br>
            <label>Konzentration (mol/L): <input type="number" id="acidConc" value="0.1" step="0.01" min="0.001"></label><br>
            <label>Volumen (mL): <input type="number" id="acidVol" value="25" step="1" min="0.1"></label>
        </fieldset>

        <fieldset>
            <legend>Indikator</legend>
            <select id="indicatorSelect">
                <option value="none">Kein Indikator</option>
                <option value="phenolphthalein">Phenolphthalein (pH 8.2 – 10.0)</option>
                <option value="methylorange">Methylorange (pH 3.1 – 4.4)</option>
            </select>
        </fieldset>

        <div>
            <button id="startBtn">Start</button>
            <button id="stopBtn">Stopp</button>
            <button id="resetBtn">Reset</button>
            <button id="reloadBtn">Seite neu laden</button>
        </div>
    </div>

    <canvas id="titrationChart" width="900" height="420"></canvas>

    <h3>Erklärung / Hinweise</h3>
    <textarea id="explanation" rows="6">Hier erscheint die Erklärung zur Titrationskurve...</textarea>

    <script>
        /* =================== Globale Variablen =================== */
        let chart;
        let running = false;
        let currentVolBase = 0; // mL
        let maxVolBase = 0;
        let intervalId = null;
        const Kw = 1e-14;

        /* =================== Indikatoren =================== */
        const indicators = {
            phenolphthalein: { range: [8.2, 10.0], color: "rgba(255, 0, 255, 0.18)" },
            methylorange: { range: [3.1, 4.4], color: "rgba(255,165,  0, 0.18)" }
        };

        /* =================== Chart =================== */
        function initChart() {
            const ctx = document.getElementById('titrationChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'pH-Wert',
                            data: [],
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0,112,243,0.08)',
                            showLine: true,
                            fill: false,
                            pointRadius: 0,
                            tension: 0.2,
                            parsing: false,
                            order: 3
                        }
                    ]
                },
                options: {
                    responsive: false,
                    animation: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'zugefügtes Volumen Base (mL)' },
                            grid: { color: 'rgba(0,0,0,0.06)' },
                            ticks: { autoSkip: true }
                        },
                        y: {
                            type: 'linear',
                            min: 0,
                            max: 14,
                            title: { display: true, text: 'pH-Wert' },
                            ticks: { stepSize: 1 },
                            grid: { color: 'rgba(0,0,0,0.06)' }
                        }
                    },
                    plugins: { legend: { display: true } }
                }
            });
        }

        /* ========== Indikatorband (farbiger Umschlagbereich) ========== */
        function setIndicatorBand(indicatorKey) {
            if (!chart) return;
            chart.data.datasets = chart.data.datasets.filter(ds => !ds._isIndicator);
            if (!indicatorKey || indicatorKey === 'none') { chart.update(); return; }

            const { range, color } = indicators[indicatorKey];
            const x0 = 0;
            const x1 = Math.max(maxVolBase || 1, 1);

            const lower = {
                label: `Indikator (${indicatorKey})`,
                data: [{ x: x0, y: range[0] }, { x: x1, y: range[0] }],
                borderColor: color,
                backgroundColor: color,
                borderWidth: 0,
                pointRadius: 0,
                fill: '+1',
                parsing: false,
                _isIndicator: true,
                order: 1
            };
            const upper = {
                data: [{ x: x0, y: range[1] }, { x: x1, y: range[1] }],
                borderColor: color,
                backgroundColor: color,
                borderWidth: 0,
                pointRadius: 0,
                parsing: false,
                _isIndicator: true,
                order: 1
            };

            chart.data.datasets.splice(1, 0, lower, upper);
            chart.update();
        }

        /* ========== Äquivalenzpunkt-Linien ========== */
        function setEquivalenceLines(eqPoints) {
            if (!chart) return;
            chart.data.datasets = chart.data.datasets.filter(ds => !ds._isEq);
            eqPoints.forEach((v, idx) => {
                chart.data.datasets.push({
                    label: `ÄP ${idx + 1}`,
                    data: [{ x: v, y: 0 }, { x: v, y: 14 }],
                    borderColor: 'red',
                    borderWidth: 1,
                    pointRadius: 0,
                    tension: 0,
                    borderDash: [6, 4],
                    parsing: false,
                    _isEq: true,
                    order: 2
                });
            });
            chart.update();
        }

        /* =================== Mathe-Helfer =================== */
        function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

        /* =================== pH-Berechnung (Original) =================== */
        function calcPH(volBase_mL) {
            const baseConc = parseFloat(document.getElementById('baseConc').value) || 0.0;
            const acidConc = parseFloat(document.getElementById('acidConc').value) || 0.0;
            const acidVol = parseFloat(document.getElementById('acidVol').value) || 0.0;
            const acidSel = document.getElementById('acidSelect');
            const pksRaw = acidSel.options[acidSel.selectedIndex].dataset.pks.split(',').map(s => s.trim());

            const acidVolL = acidVol / 1000.0;
            const volBaseL = volBase_mL / 1000.0;
            const totalVolL = acidVolL + volBaseL;

            const molesAcid = acidConc * acidVolL;     // HnA-Moleküle (gesamt)
            const molesBase = baseConc * volBaseL;     // zugefügte OH^-

            // Auftrennen: starke vs. schwache Stufen
            const strongCount = pksRaw.filter(pk => pk === 'strong').length;
            const weakPKs = pksRaw.filter(pk => pk !== 'strong').map(parseFloat);
            let weakKa = weakPKs.map(pka => Math.pow(10, -pka));

            // 1) Starke Protonen stoichiometrisch neutralisieren
            const molesStrong = strongCount * molesAcid; // Äquivalente aus starken Stufen
            if (molesBase < molesStrong) {
                // Noch im "starken" Bereich: starke Säure neutralisieren
                const netH = molesStrong - molesBase;   // verbleibende H+-Äquivalente
                const Hconc = netH / totalVolL;
                return clamp(-Math.log10(Hconc), 0, 14);
            }
            // Nach Neutralisation der starken Stufen: verbleibende Base
            const molesBase_eff = molesBase - molesStrong;

            // 2) Jetzt nur noch schwache Stufen (0 bis n)
            const Ct = (molesAcid / totalVolL);       // Gesamt-Konzentration an Rest-Spezies (z. B. HSO4- bei H2SO4)
            const cM = (molesBase_eff / totalVolL);   // Kationen aus Maßlösung, die noch "frei" sind

            // Relevanzfilter (vermeidet künstliche Knicke für extrem schwache Stufen)
            const EPS = 1e-10; // konservativ
            weakKa = weakKa.filter(K => (K * Ct) > EPS);
            const nStagesWeak = weakKa.length;

            // Wenn es gar keine schwache Stufe (relevant) gibt:
            if (nStagesWeak === 0) {
                // Nur noch OH^- Überschuss (oder pH ~ 7, falls cM ~ 0)
                if (molesBase_eff > 0) {
                    const OH = (molesBase_eff) / totalVolL;
                    const pOH = -Math.log10(OH);
                    return clamp(14 - pOH, 0, 14);
                } else {
                    return 7.0;
                }
            }

            // Für rein schwache (keine starken Stufen) und OH-Überschuss über alle schwachen Protonen:
            const totalWeakProtons = nStagesWeak * molesAcid;
            if (molesBase_eff >= totalWeakProtons) {
                const OHex = molesBase_eff - totalWeakProtons;
                const OHconc = OHex / totalVolL;
                const pOH = -Math.log10(OHconc);
                return clamp(14 - pOH, 0, 14);
            }

            // Ladungsbilanz f(H) = [H+] + cM - [OH-] - Ct * Σ k * alpha_k(H)
            function f(H) {
                if (H <= 0) H = 1e-18;

                // Verteilungsfaktoren alpha_k über schwache Stufen
                // N0 = 1, Nk = (Ka1*...*Kak) / H^k
                let D = 1.0; // für k=0
                const Nk = [1.0];
                for (let k = 1; k <= nStagesWeak; k++) {
                    let prodKa = 1.0;
                    for (let i = 0; i < k; i++) prodKa *= weakKa[i];
                    const term = prodKa / Math.pow(H, k);
                    Nk.push(term);
                    D += term;
                }

                let negChargeFromAcid = 0.0; // Σ k * alpha_k
                for (let k = 1; k <= nStagesWeak; k++) {
                    const alpha_k = Nk[k] / D;
                    negChargeFromAcid += k * alpha_k;
                }
                negChargeFromAcid *= Ct;

                const OH = Kw / H;
                return H + cM - OH - negChargeFromAcid;
            }

            // Bisection in log-Skala
            let Hlow = 1e-16, Hhigh = 1e2;
            let fLow = f(Hlow), fHigh = f(Hhigh);
            if (fLow * fHigh > 0) {
                Hlow = 1e-20; Hhigh = 1e6;
                fLow = f(Hlow); fHigh = f(Hhigh);
                if (fLow * fHigh > 0) {
                    // Fallback: Henderson–Hasselbalch auf erste relevante schwache Stufe
                    const pKa = -Math.log10(weakKa[0]);
                    const estRatio = (molesBase_eff / molesAcid) || 1e-6;
                    return clamp(pKa + Math.log10(estRatio), 0, 14);
                }
            }

            let Hmid = 1e-7;
            for (let iter = 0; iter < 200; iter++) {
                Hmid = Math.sqrt(Hlow * Hhigh);
                const fMid = f(Hmid);
                if (Math.abs(fMid) < 1e-12) break;
                if (fLow * fMid <= 0) { Hhigh = Hmid; fHigh = fMid; }
                else { Hlow = Hmid; fLow = fMid; }
            }

            let pH = -Math.log10(Hmid);
            return clamp(pH, 0, 14);
        }

        /* =================== Schritt-Funktion =================== */
        function step() {
            if (!running) return;
            currentVolBase += 0.25; // mL pro Schritt
            if (currentVolBase > maxVolBase) {
                running = false;
                clearInterval(intervalId);
                return;
            }
            const pH = calcPH(currentVolBase);
            const dataset = chart.data.datasets[0]; // pH-Dataset
            dataset.data.push({ x: currentVolBase, y: pH });
            chart.update();
        }

        /* =================== Events =================== */
        document.getElementById('startBtn').addEventListener('click', () => {
            if (running) return;

            const acidConc = parseFloat(document.getElementById('acidConc').value) || 0.0;
            const acidVol = parseFloat(document.getElementById('acidVol').value) || 0.0;
            const baseConc = parseFloat(document.getElementById('baseConc').value) || 0.0;

            const pksValues = document.getElementById('acidSelect').options[document.getElementById('acidSelect').selectedIndex].dataset.pks.split(',').map(s => s.trim());
            const stages = pksValues.length;

            // Äquivalenzpunkt(e) (naive Anzahl Stufen * 1. Äquivalent-Volumen)
            const eqVolFirstStage = (acidConc * acidVol) / baseConc; // mL pro Äquivalent
            const eqPoints = [];
            for (let i = 1; i <= stages; i++) eqPoints.push(eqVolFirstStage * i);

            // X-Achse bis 150 % des letzten ÄP
            maxVolBase = Math.max(eqVolFirstStage * stages * 1.5, 1);
            chart.options.scales.x.min = 0;
            chart.options.scales.x.max = maxVolBase;

            // Achsenunterteilung: ca. 10 Segmente
            const approxTicks = Math.max(1, Math.round(maxVolBase / 10));
            if (!chart.options.scales.x.ticks) chart.options.scales.x.ticks = {};
            chart.options.scales.x.ticks.stepSize = approxTicks;

            // Reset pH-Daten
            chart.data.datasets[0].data = [];

            // ÄP-Linien & Indikatorband
            setEquivalenceLines(eqPoints);
            setIndicatorBand(document.getElementById('indicatorSelect').value);

            // Start
            currentVolBase = 0;
            running = true;
            intervalId = setInterval(step, 80);

            document.getElementById('explanation').value =
                `Säure: ${document.getElementById('acidSelect').selectedOptions[0].text}
Konzentration Säure: ${acidConc} mol/L, Volumen: ${acidVol} mL
Maßlösung: ${baseConc} mol/L
Äquivalenzpunkte (mL): ${eqPoints.map(v => v.toFixed(2)).join(', ')}`;
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            running = false;
            clearInterval(intervalId);
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            clearInterval(intervalId);
            chart.data.datasets = [chart.data.datasets[0]];
            chart.data.datasets[0].data = [];
            chart.options.scales.x.min = 0;
            chart.options.scales.x.max = undefined;
            chart.options.scales.x.ticks = {};
            chart.update();
            currentVolBase = 0;
            maxVolBase = 0;
            document.getElementById('explanation').value = 'Hier erscheint die Erklärung zur Titrationskurve...';
        });

        document.getElementById('reloadBtn').addEventListener('click', () => { location.reload(); });

        // Indikatorwechsel live
        document.getElementById('indicatorSelect').addEventListener('change', (e) => {
            setIndicatorBand(e.target.value);
        });

        // 🧩 Safari-Rendering-Fix: initChart erst nach vollständigem load + RAF + kurzer Pause
        function safeInit() {
            if (chart) return;
            initChart();
            // wenn bereits Indikator ausgewählt, zeigt Band (ggf. mit maxVolBase==0 -> x1=1)
            setIndicatorBand(document.getElementById('indicatorSelect').value);
        }

        window.addEventListener("load", () => {
            requestAnimationFrame(() => {
                setTimeout(safeInit, 120);
            });
        });

        // pageshow für bfcache (zurück-navigieren auf iOS/Safari)
        window.addEventListener('pageshow', (e) => {
            if (e.persisted) {
                requestAnimationFrame(() => setTimeout(safeInit, 120));
            }
        });
    </script>
</body>
</html>
